# Trade War Networks — Data & Notebook

This repository contains a single, end‑to‑end notebook and supporting data for analyzing **trade‑war–driven supply‑chain rewiring** using UN Comtrade and World Bank data. The project builds a country–partner trade network, detects structural breaks in bilateral flows, and estimates an environmental footprint proxy (shipping distance & CO₂ intensity).

> **Notebook**: `trade_war_networks_single_notebook.ipynb`  
> **Python**: 3.10+

---

## Contents

- **`notebooks/`** *(optional)* — if you later split the workflow, keep notebooks here.  
- **`data/`**
  - `raw/` — input datasets (original files, API pulls, snapshots).
  - `processed/` — derived data generated by the notebook.
- **`figures/`** — charts exported by the notebook (PNG/SVG).
- **`reports/`**
  - `tables/` — CSV/XLSX tables exported by the notebook.
- **`README.md`**, **`.gitignore`**

> The notebook defaults to a **local layout** rooted at the repo (see: `BASE = Path('.')`). It also contains convenience helpers to run on Google Drive/Colab. If you run locally, you do not need Google Drive.

---

## What the notebook does (high level)

1. **Collects data**
   - Option A: Fetch **UN Comtrade Preview API** chunks (quota‑aware, cached) for selected years, HS2 sections (e.g., 84/85), and focus countries.
   - Option B: Run with **synthetic data** (for dry runs and smoke tests).
   - Optionally pulls **World Bank** indicators for macro context.

2. **Builds a trade network**
   - Aggregates to country–partner–HS2–flow; computes centrality metrics and (optional) greedy modularity communities.

3. **Detects structural breaks & forecasts**
   - Uses `ruptures` and classical time‑series models (ARIMA / Holt–Winters) on partner shares and bilateral trade series.
   - Saves breakpoints, summaries, and example figures.

4. **Environmental impact proxy**
   - Estimates shipping distance by great‑circle approximations and a coarse **g/t‑km** factor to approximate **CO₂**.
   - Produces year‑over‑year deltas, rankings, and heatmaps.

---

## Key outputs (file names)

- **Breaks & forecasts (Part 3)**
  - `reports/tables/part3_breakpoints.csv`
  - `reports/tables/part3_breakpoints_summary.csv`
  - `reports/tables/part3_forecasts.csv`
  - `reports/tables/part3_forecasts_summary.csv`
  - `figures/part3_figA_usa_hs85_trio.png`
  - `figures/part3_figB_break_{rep}_{par}_HS{hs}_{fl}.png`
  - `figures/part3_figC_forecast_{rep}_{par}_HS{hs}_{fl}.png`
  - `figures/part3_figD_heatmap_growth_usa_hs84_85.png`

- **Environmental impact (Part 4)**
  - `reports/tables/part4_co2_by_route_year.csv`
  - `reports/tables/part4_co2_by_year_reporter.csv`
  - `reports/tables/part4_co2_intensity_by_reporter.csv`
  - `figures/part4_distance_heatmap.png`
  - `figures/part4_usa_co2_2017_vs_2022.png`
  - `figures/part4_usa_co2_delta_2017_2022.png`
  - `figures/part4_usa_co2_intensity.png`
  - `figures/part4_sensitivity_usa2022.png`

- **Network summary**
  - `data/processed/trade_network_ready.parquet`
  - `data/processed/node_metrics.parquet`
  - `data/processed/node_metrics_with_communities.parquet`
  - `reports/tables/trade_network_summary.xlsx`

> The notebook also caches Comtrade chunks under `data/raw/chunks/` as `comtrade_preview_*.parquet` when `use_api_calls=True`.

---

## Configuration

Configuration is done via a Python `dict` inside the notebook (and is saved to `data/processed/config.json` for reproducibility). The main keys you can edit:

```python
config = {
    "years": list(range(2015, 2023)),
    "focus_countries": ["USA","CHN","VNM","MEX","DEU","JPN","KOR","CAN","TWN","THA","MYS"],
    "hs_sections": ["84","85"],             # HS2 sections analyzed
    "use_api_calls": True,                   # True → hit Comtrade Preview API; False → synthetic demo data
    "preview_max_records": 500,              # API chunk size
    "sleep_between_calls": 1.2,              # polite throttle (seconds)

    # Quota-aware behavior
    "respect_quota_sleep": True,
    "quota_sleep_ceiling_min": 30,

    # World Bank indicators for context
    "wb_indicators": ["NE.TRD.GNFS.ZS","NY.GDP.MKTP.CD","NY.GDP.MKTP.KD","FP.CPI.TOTL"]
}

# Partner scope for API collection: "focus" (only focus countries) or "world" (all partners)
PARTNER_MODE = "focus"
```

If you run with `use_api_calls=True`, you will need internet access. The notebook uses [`comtradeapicall`](https://pypi.org/project/comtradeapicall/) for the Preview API and writes results to `data/raw/chunks/` and assembled parquet files to `data/raw/`.

---

## How to run (local)

1. **Create an environment (Python 3.10+)**
   ```bash
   python -m venv .venv
   source .venv/bin/activate   # Windows: .venv\\Scripts\\activate
   pip install --upgrade pip
   ```

2. **Install dependencies**
   ```bash
   pip install numpy pandas matplotlib plotly networkx ruptures statsmodels scipy requests openpyxl
   # Optional (for live data collection)
   pip install comtradeapicall
   ```

3. **Run the notebook**
   - Open `trade_war_networks_single_notebook.ipynb` in Jupyter/VS Code/PyCharm.
   - Run all cells **top‑to‑bottom**. Folders under `data/`, `figures/`, and `reports/` are created automatically.
   - Outputs will be written as shown above.

> **Note on data**: If your raw data is already included in the repo, place it under `data/raw/` (the notebook will find or create the expected files).

---

## How to run (Google Colab + Drive) *(optional)*

The notebook contains helpers to mount Drive (e.g., to `.../MyDrive/TradeWar/latest`) and will mirror the same folder layout there. Follow the in‑notebook prompts in the **“Google Drive”** section if you choose this route.

---

## Reproducibility

- The code writes a machine‑readable snapshot (`data/processed/manifest.json`, `data/processed/config.json`) summarizing inputs and outputs.
- All generated artifacts are **idempotent**: rerunning cells will overwrite prior outputs with the same names.

---

## Dependencies

- Python ≥ 3.10
- `numpy`, `pandas`, `matplotlib`, `plotly`, `networkx`
- `ruptures`, `statsmodels`, `scipy`
- `requests`
- `openpyxl` (for Excel export)
- **Optional**: `comtradeapicall` (Preview API client)

---

## Short Hebrew summary (תקציר בעברית)

הפרויקט בונה רשת סחר מדינות–שותפות, מזהה **שבירות מבניות** בזרמי יבוא/יצוא (לדוגמה ב‑HS84/85), ומעריך באופן גס את **ההשפעה הסביבתית** דרך מרחקי שינוע ו‑CO₂. המחברת רצה מקצה‑לקצה, כותבת את כל הפלטים לתיקיות `data/processed`, `figures`, ו‑`reports/tables`, וכוללת אפשרות למשיכת נתונים חיה מ‑UN Comtrade (או עבודה עם דאטה סינתטי לבדיקות).

---

## License

If you plan to open‑source the repository, add a LICENSE file (e.g., MIT). Otherwise feel free to remove this section.
